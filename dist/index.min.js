function e(e,...r){const t=r.length;if(t<1||null==e)return e;for(let o=0;o<t;o++){const t=r[o];for(const r in t)e[r]=t[r]}return e}function r(e){return!!e._readableState||!!e._writableState}function t(e){return r=>new e.Observable((e=>{const t=r.subscribe(e);return e.complete(),t}))}function o({core:e}){return r=>x(e.session(r))}function n({core:e}){return r=>x(e.snapshot(r))}function c({core:t,rx:o,Hypercore:n}){return c=>{if(c instanceof n&&(c=x(c)),c?.isRxCore&&(c=c.replicate$()),c&&r(c)){const r=c;c=e(o.fromEvent(r,"data"),{next(e){r.write(e)},complete(){r.end()},error(e){r.destroy(e)}})}const s=!!c,a=t.replicate(s);if(c)return o.fromEvent(a,"data").subscribe(c),c.subscribe({next(e){a.write(e)},complete(){a.end()},error(e){a.destroy(e)}});return e(o.fromEvent(a,"data"),{next(e){a.write(e)},complete(){a.end()},error(e){a.destroy(e)},stream:a})}}function s(e){const{rx:r,ready$:t}=e;return(n=o)=>t.pipe(r.switchMap((t=>r.of(t.findingPeers()).pipe(r.concatMap((t=>n(e).pipe(r.map((()=>t())))))))));function o(){return r.timer(6e3)}}function a({rx:e,ready$:r}){return t=>r.pipe(e.switchMap((e=>e.download(t).done().then((()=>e)))))}function i({ready$:e,rx:r}){return e.pipe(r.switchMap((e=>r.fromEvent(e,"peer-remove").pipe(r.map((()=>e))))))}function p({ready$:e,rx:r}){return e.pipe(r.switchMap((e=>r.fromEvent(e,"peer-add").pipe(r.map((()=>e))))))}function d({ready$:e,rx:r}){return e.pipe(r.switchMap((e=>r.fromEvent(e,"close").pipe(r.map((()=>e))))))}function u({ready$:e,rx:r}){return e.pipe(r.switchMap((e=>r.fromEvent(e,"append").pipe(r.map((()=>e))))))}function l({ready$:e,rx:r}){return(t,o)=>e.pipe(r.switchMap((e=>e.get(t,o))))}function f(e){const{rx:r,ready$:t}=e;return o=>t.pipe(r.switchMap((t=>r.from("function"==typeof o?o(e):r.of(o)).pipe(r.concatMap((e=>t.append(e).then((r=>({...r,value:e})))))))))}function m({rx:e,core:r}){return e.defer((()=>r.ready())).pipe(e.map((()=>r)))}function y({rx:e,ready$:r}){return t=>r.pipe(e.switchMap((e=>e.createReadStream(t))))}function g({rx:e,ready$:r}){return t=>r.pipe(e.switchMap((e=>e.createByteStream(t))))}function x(e){return b.createScope().register({core:h((()=>e)).scoped()}).cradle}function w(e={}){const{rx:r}=b.cradle;if("number"==typeof e&&(e=Array(e)),r.isObservable(e)||Array.isArray(e)){const o=[];return r.from(e).pipe(t(r)).subscribe((e=>o.push(e))),o.map(w)}const{storage:o=b.cradle.makeFile}=e;return b.createScope().register({storage:v(o),config:v(e),core:h((({Hypercore:e,storage:r,config:t})=>new e(r,t))).scoped()}).cradle}let b,$,h,v,M,C=0,A=0;async function E(e={}){if(e={...G,...e},C++&&b)return b;if(A++)return new Promise((e=>{const r=setInterval((()=>{A||(e(b),clearInterval(r))}),100)}));const r=await J(e);await async function(){return G.dependencies.hypercore||={get:()=>G.importModule("hypercore").then((e=>e.default))}}(),b=r.createScope(),({createContainer:$,asFunction:h,asValue:v,aliasTo:M}=b.cradle);const t=await Q("hypercore");return A--,b.register({isRxCore:v(!0),Hypercore:v(t),ready$:h(m).scoped(),createReadStream$:h(y).scoped(),createByteStream$:h(g).scoped(),append$:h(f).scoped(),append:h((({core:e})=>r=>e.append(r))),get:h((({core:e})=>(r,t)=>e.get(r,t))),download$:h(a).scoped(),replicate$:h(c).scoped(),session:h(o).scoped(),snapshot:h(n).scoped(),onAppend$:h(u).scoped(),onPeerRemoved$:h(i).scoped(),onPeerAdd$:h(p).scoped(),onClose$:h(d).scoped(),findingPeers$:h(s).scoped(),next:h((({core:e})=>r=>e.append(r))).scoped(),complete:h((({core:e})=>()=>{})).scoped(),error:h((({core:e})=>()=>e.close())).scoped(),key:h((({core:e})=>e.key)).transient(),discoveryKey:h((({core:e})=>e.discoveryKey)).transient(),get$:h(l).scoped(),close:h((({core:e})=>()=>e.close())),ready:h((({core:e})=>()=>e.ready().then((()=>e))))})}var S=Object.freeze({__proto__:null,create:w,fromCore:x,fromReplication:function(e,r,t){const{Hypercore:o,b4a:n}=b.cradle;({stream$:e,key:r,config:t}=function(e){const r={};for(let t of e)t instanceof o||t?.isRxCore||n.isBuffer(t)?(r.stream$||=t,r.key=t?.key||t):"object"==typeof t&&(r.config=t);r.config||(r.config={});return r}([e,r,t])),r?.isRxCore&&(r=r.key);const c=w({key:r,...t});return c.core.once("close",c.replicate$(e).unsubscribe),c},install:E});function R({corestore:e}){return r=>x(e.get(r))}function k({get:e,rx:r}){return t=>r.of(e(t))}function j({corestore:e}){return r=>H(e.session(r))}function P({corestore:e}){return r=>H(e.namespace(r))}function _({rx:e,corestore:r}){return e.fromEvent(r,"core-open")}function F({rx:e,corestore:r}){return e.fromEvent(r,"core-close")}function I({corestore:t,rx:o,Corestore:n}){return c=>{if(c instanceof n&&(c=H(c)),c?.isRxCorestore&&(c=c.replicate$()),c&&r(c)){const r=c;c=e(o.fromEvent(r,"data"),{next(e){r.write(e)},complete(){r.end()},error(e){r.destroy(e)}})}const s=!!c,a=t.replicate(s);if(c)return o.fromEvent(a,"data").subscribe(c),c.subscribe({next(e){a.write(e)},complete(){a.end()},error(e){a.destroy(e)}});return e(o.fromEvent(a,"data"),{next(e){a.write(e)},complete(){a.end()},error(e){a.destroy(e)},stream:a})}}function O(e){const{rx:r,corestore:t}=e;return(n=o)=>r.of(t.findingPeers()).pipe(r.concatMap((t=>n(e).pipe(r.map((()=>t()))))));function o(){return r.timer(6e3)}}function H(e){return T.createScope().register({corestore:B((()=>e)).scoped()}).cradle}let T,V,B,z,D,K=0,L=0;var N=Object.freeze({__proto__:null,create:function e(r={}){const{rx:o}=T.cradle;if("number"==typeof r&&(r=Array(r)),o.isObservable(r)||Array.isArray(r)){const n=[];return o.from(r).pipe(t(o)).subscribe((e=>n.push(e))),n.map(e)}const{storage:n=T.cradle.makeFile}=r;return T.createScope().register({storage:z(n),config:z(r),corestore:B((({Corestore:e,storage:r,config:t})=>new e(r,t))).scoped()}).cradle},fromCorestore:H,install:async function(e={}){if(e={...G,...e},K++&&T)return T;if(L++)return new Promise((e=>{const r=setInterval((()=>{L||(e(T),clearInterval(r))}),100)}));const r=await J(e);await E(e),await async function(){return G.dependencies.corestore||={get:()=>G.importModule("corestore").then((e=>e.default))}}(),T=r.createScope(),({createContainer:V,asFunction:B,asValue:z,aliasTo:D}=T.cradle);const t=await Q("corestore");return L--,T.register({isRxCorestore:z(!0),Corestore:z(t),replicate$:B(I).scoped(),get$:B(k).scoped(),get:B(R).scoped(),session:B(j).scoped(),namespace:B(P).scoped(),onCoreOpen$:B(_).scoped(),onCoreClose$:B(F).scoped(),close:B((({corestore:e})=>()=>e.close())).scoped(),findingPeers$:B(O).scoped(),next:B((()=>{})),complete:B((()=>{})),error:B((()=>{}))})}});let U,Y=0,q=0,G={resolvedDependencies:{},dependencies:{rxjs:{get:()=>G.importModule("rxjs")},"rxjs/operators":{get:()=>G.importModule("rxjs/operators")},"random-access-memory":{get:()=>G.importModule("random-access-memory").then((e=>e.default)),optional:!0},awilix:{get:()=>G.importModule("awilix",(()=>"https://esm.run/awilix@10.0.1/lib/awilix.browser.js"))},"compact-encoding":{get:()=>G.importModule("compact-encoding").then((e=>e.default))},b4a:{get:()=>G.importModule("b4a").then((e=>e.default))}},importModule:async function(e,r=((e,r)=>`https://esm.run/${e}`)){let t,o="undefined"!=typeof process&&process?.versions?.node;try{new URL(e),t=!0}catch(e){t=!1}if(t&&o)throw new Error("You cannot import url modules via node.");return await import(t?e:r(e,G))},defaultStorage:"random-access-memory",makeFile:(e,...r)=>new e(...r)};async function J(e={}){if(G={...G,...e},Y++&&U)return U;if(q++)return new Promise((e=>{const r=setInterval((()=>{q||(e(U),clearInterval(r))}),100)}));const[r,t,{createContainer:o,asFunction:n,asValue:c,aliasTo:s},a,i,p]=await Q(["rxjs","rxjs/operators","awilix",G.defaultStorage,"compact-encoding","b4a"]);return U=o(),q--,U.register({rx:c({...t,...r}),makeFile:n((({randomAccess:e})=>(...r)=>G.makeFile(e,...r))),schedule:c(null),createContainer:c(o),asFunction:c(n),asValue:c(c),aliasTo:c(s),cenc:c(i),b4a:c(p),randomAccess:c(a)})}async function Q(e){if(Array.isArray(e))return Promise.all(e.map((e=>Q(...Array.isArray(e)?e:[e],G))));const r=G.dependencies[e]||{},{optional:t}=r;try{return G.resolvedDependencies[e]||=await G.dependencies[e].get()}catch(r){if(!t)throw new Error(`Non-optional dependency '${e}' could not be resolved.`);return{}}}export{S as RxCore,N as RxCorestore,G as configuration,J as install,Q as installDependency};
